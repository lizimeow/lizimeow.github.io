---
title: "RxJS å­¦ä¹ -(3)-é”™è¯¯å¤„ç†"
date: 2017-06-12 15:09:16
tags: RxJS
---

### catch

åœ¨ RxJS ä¸­çš„ catch èƒ½å¤Ÿå›ä¼ ä¸€ä¸ª observable æ¥é€å‡ºæ–°çš„å€¼

ç›´æ¥çœ‹ğŸŒ°:

å½“é”™è¯¯å‘ç”Ÿåå°±ä¼š catch å¹¶é‡æ–°å¤„ç†ä¸€ä¸ªæ–°çš„ observable æˆ‘ä»¬å¯ä»¥åˆ©ç”¨è¿™ä¸ªæ–°çš„ observable æ¥é€å‡ºæˆ‘ä»¬æƒ³é€çš„å€¼

```javascript
const source = Rx.observable.from(['a', 'b', 'c', 'd', 2])
				.zip(Rx.Observable.interval(500), (x, y) => x)
const example = source
				.map(x => x.toUpperCase())
				.catch(err => Rx.Observable.of('h'))
example.subscribe({
    next: value => console.log(value),
  	error: err => console.log(err),
  	complete: _ => console.log('complete!')
})
// A B C D h complete!
```

ä¹Ÿå¯ä»¥åœ¨é‡åˆ°é”™è¯¯å, è®© observable ç»“æŸ, å¦‚ä¸‹

```javascript
const source = Rx.observable.from(['a', 'b', 2, 'd', 2])
				.zip(Rx.Observable.interval(500), (x, y) => x)
const example = source
				.map(x => x.toUpperCase())
				.catch(err => Rx.Observable.empty())
// A B complete!
```

catch çš„ç¬¬äºŒä¸ªå‚æ•°æ¥æ”¶çš„æ˜¯å½“å‰çš„ observable

```javascript
const source = Rx.observable.from(['a', 'b', 2, 'd', 2])
				.zip(Rx.Observable.interval(500), (x, y) => x)
const example = source
				.map(x => x.toUpperCase())
				.catch((err, obs) => obs)
// A B A B A B A B...
```

è¿™é‡Œå¯ä»¥çœ‹åˆ°æˆ‘ä»¬ç›´æ¥å›ä¼ äº†å½“å‰çš„ observable ,ä¹Ÿå°±æ˜¯ example æ¥é‡æ–°æ‰§è¡Œ

å› ä¸ºåªæ˜¯ç®€å•çš„ç¤ºèŒƒ,  æ‰€ä»¥è¿™é‡Œä¼šä¸€ç›´æ— é™å¾ªç¯, é€šå¸¸ä¼šç”¨åœ¨**æ–­çº¿é‡è¿**çš„æƒ…æ™¯

ä¸Šé¢çš„å¤„ç†æ–¹å¼æœ‰ä¸€ä¸ªç®€åŒ–çš„å†™æ³•, å«åš `retry`

### retry

å¦‚æœæˆ‘ä»¬æƒ³è¦å®ç° å½“ observable å‘ç”Ÿé”™è¯¯æ—¶é‡æ–°å°è¯•å°±å¯ä»¥ç”¨ retry è¿™ä¸ªæ–¹æ³•

```javascript
const source = Rx.Observable.from(['a', 'b', 'c', 'd', 2])
				.zip(Rx.Observable.interval(500), (x, y) => x)
const example = source.map(v => v.toUpperCase()).retry()
example.subscribe({
    next: v => console.log(v),
  	error: err => console.log(err),
  	complete: () => console.log('complete')
})
// A B C D A B C D A B C D...
```

æˆ‘ä»¬ä¹Ÿå¯ä»¥è®¾å®šåªå°è¯•å‡ æ¬¡, è­¬å¦‚`retry(1)`

retry å¾ˆé€‚åˆç”¨åœ¨ HTTP request å¤±è´¥çš„åœºæ™¯ä¸­, æˆ‘ä»¬å¯ä»¥è®¾å®šé‡æ–°å‘é€å‡ æ¬¡ååœ¨å±•ç¤ºé”™è¯¯ä¿¡æ¯

### retryWhen

ä¸€èˆ¬æˆ‘ä»¬ä¼šä½¿ç”¨ retryWhen æ¥åšé”™è¯¯é€šçŸ¥æˆ–è€…æ„å¤–æ”¶é›†, ğŸŒ°å¦‚ä¸‹:

```javascript
const source = Rx.Observable.from(['a', 'b', 'c', 'd', 2])
				.zip(Rx.Observable.interval(500), (x, y) => x)
const example = source.map(v => v.toUpperCase())
				.retryWhen(errObs => errObs.map(err => fetch('...')))
// example è®¢é˜…éƒ¨åˆ†çœç•¥..
```

è¿™é‡Œçš„`errObs => errObs.map(err => fetch('...'))`å¯ä»¥æŠŠ errObs é‡Œçš„æ¯ä¸ªé”™è¯¯å˜æˆ api å‘é€.

> retryWhen å®é™…ä¸Šæ˜¯å»ºç«‹äº†ä¸€ä¸ª Subject å¹¶æŠŠé”™è¯¯æ”¾å…¥, ç„¶åå¯¹è¿™ä¸ª Subject è¿›è¡Œå†…éƒ¨çš„è®¢é˜…. è¿™ä¸ª Subject é¢„è®¾æ˜¯æ— é™çš„, å¦‚æœæˆ‘ä»¬æŠŠå®ƒç»“æŸ,åŸæœ¬çš„ observable ä¹Ÿä¼šè·Ÿç€ç»“æŸ

### repeat

repeat çš„è¡Œä¸ºè·Ÿ retry åŸºæœ¬ä¸€è‡´, åªæ˜¯ retry åªæœ‰åœ¨ä¾‹å¤–å‘ç”Ÿæ—¶æ‰è§¦å‘

### ä¸€ä¸ªå®ä¾‹:

```javascript
// é”™è¯¯å¤„ç†
const title = document.getElementById('title')
const source = Rx.Observable.from(['a','b','c','d',2])
			.zip(Rx.Observable.interval(500), (x,y) => x)
			.map(x => x.toUpperCase())
// é€šå¸¸ source ä¼šå»ºç«‹å³æ—¶åŒæ­¥çš„è¿çº¿, åƒæ˜¯ web socket
const example = source.catch((err, obs) => {
    Rx.Observable.empty()
  	.startWith('è¿çº¿å‘ç”Ÿé”™è¯¯: 5s åé‡è¿')
  	.concat(obs.delay(5000))
})
```

åˆ©ç”¨ catch è¿”å›ä¸€ä¸ªæ–°çš„ observable, è¿™ä¸ª observable ä¼šå…ˆé€å‡ºé”™è¯¯ä¿¡æ¯, å¹¶ä¸”æŠŠåŸæœ¬çš„ observable å»¶è¿Ÿ5ç§’åœ¨åšåˆå¹¶