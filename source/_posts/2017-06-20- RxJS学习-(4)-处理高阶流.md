---
title: "RxJS å­¦ä¹ -(4)-å¤„ç†é«˜é˜¶æµ"
date: 2017-06-20 20:00:00
tags: RxJS
---
# å¤„ç†é«˜é˜¶æµ(high order observable)

 æ‰€è°“é«˜é˜¶æµå°±æ˜¯æŒ‡ä¸€ä¸ª observable é€å‡ºçš„å…ƒç´ è¿˜æ˜¯ä¸€ä¸ª observable, åƒæ˜¯äºŒç»´çŸ©é˜µä¸€æ ·,é€šå¸¸æˆ‘ä»¬éœ€è¦çš„å…ƒç´ æ˜¯ç¬¬äºŒå±‚çš„ observable é€å‡ºçš„å…ƒç´ , æ‰€ä»¥æˆ‘ä»¬å¸Œæœ›å¯ä»¥æŠŠäºŒç»´çš„ observable å˜æˆä¸€ç»´çš„

### switch

åœ¨æ–°çš„ observable é€å‡ºåŽç›´æŽ¥å¤„ç†æ–°çš„ observable ä¸ç®¡å‰ä¸€ä¸ª observable æ˜¯å¦å®Œæˆï¼Œæ¯å½“æœ‰æ–°çš„ observable é€å‡ºå°±ä¼šç›´æŽ¥æŠŠæ—§çš„ observable é€€è®¢(unsubscribe)ï¼Œ**æ°¸é åªå¤„ç†æœ€æ–°çš„ observable!**

### concatAll

concatAll æœ€é‡è¦çš„ç‚¹å°±æ˜¯ä»–ä¼šå¤„ç†å®Œå‰ä¸€ä¸ª observable æ‰æœƒåœ¨å¤„ç†ä¸‹ä¸€ä¸ªobservable, ä¸²è¡Œå¤„ç†. ä¹Ÿå°±æ˜¯ä¸€å®šæ˜¯ç­‰å‰ä¸€ä¸ª observable å®ŒæˆåŽæ‰ä¼šå¤„ç†ä¸‹ä¸€ä¸ª

### mergeAll

å¯¹æ‰€æœ‰çš„ observable å¹¶è¡Œå¤„ç†

mergeAll è¿˜å¯ä»¥ä¼ å…¥ä¸€ä¸ªæ•°å€¼, ä»£è¡¨ä»–å¯ä»¥åŒæ—¶å¤„ç†çš„ observable çš„æ•°é‡

å¦‚æžœæ•°é‡è®¾ç½®äº†2 ,å‰ä¸¤ä¸ªæµæ˜¯å¹¶è¡Œå¤„ç†çš„, ç¬¬ä¸‰ä¸ªæµä¼šç­‰ç¬¬ä¸€ä¸ªæµç»“æŸäº†ä¹‹åŽæ‰ä¼šå¼€å§‹æ‰§è¡Œ

### concatMap

concatMap å…¶å®žæ˜¯ concatAll åŠ ä¸Š map çš„ç®€æ˜“å†™æ³•, ðŸŒ°å¦‚ä¸‹:

```javascript
const source = Rx.Observable.fromEvent(document.body, 'click')
const example = source.map(e => Rx.Observable.interval(1000).take(3)).concatAll()
```

ä¸Šé¢è¿™ä¸ªç¤ºä¾‹å°±å¯ä»¥ç®€åŒ–æˆ

```javascript
const source = Rx.Observable.fromEvent(document.body, 'click')
const example = source.concatMap(e =>
	Rx.Observable.interval(1000).take(3)
)
```

```javascript
// Marble Diagram
source : -----------c--c------------------...
        concatMap(c => Rx.Observable.interval(100).take(3))
example: -------------0-1-2-0-1-2---------...
```

è¿™æ ·çš„è¡Œä¸ºä¹Ÿå¾ˆå¸¸ç”¨åœ¨å‘é€ request çš„æ—¶å€™:

```javascript
function getPostData() {
    return fetch('https://jsonplaceholder.typicode.com/posts/1')
 	 .then(res => res.json())
}
const source = Rx.Observable.fromEvent(document.body, 'click')
const example = source.concatMap(e => Rx.Observable.from(getPostData()))
```

è¿™æ ·æˆ‘ä»¬æ¯æ¬¡ç‚¹å‡»å°±ä¼šé€å‡ºä¸€ä¸ª http request, å¦‚æžœæˆ‘ä»¬å¿«é€Ÿè¿žç»­ç‚¹å‡», å¯ä»¥åœ¨å¼€å‘è€…å·¥å…·çš„ network çœ‹åˆ°æ¯ä¸ª request éƒ½æ˜¯ç­‰åˆ°å‰ä¸€ä¸ª request å®ŒæˆåŽæ‰é€å‡ºä¸‹ä¸€ä¸ª request çš„

concatMap çš„ç¬¬äºŒä¸ªå‚æ•°æ˜¯ä¸€ä¸ª callback, è¿™ä¸ª callback ä¼šä¼ å…¥å››ä¸ªå‚æ•°, åˆ†åˆ«æ˜¯

1. å¤–éƒ¨ observable é€å‡ºçš„å…ƒç´ 
2. å†…éƒ¨ observable é€å‡ºçš„å…ƒç´ 
3. å¤–éƒ¨ observable é€å‡ºå…ƒç´ çš„ index
4. å†…éƒ¨ observable é€å‡ºå…ƒç´ çš„ index

ç”¨æ¥ä¼ å›žæˆ‘ä»¬æƒ³è¦çš„å€¼

### switchMap

switchMap æ˜¯ switch åŠ ä¸Š map çš„ç®€æ˜“å†™æ³•

å¾ˆé€‚åˆç”¨åœ¨åªçœ‹æœ€åŽä¸€ä¸ª request çš„æƒ…æ™¯, æ¯”å¦‚è¯´è¾“å…¥æ–‡å­—è‡ªåŠ¨å®Œæˆçš„æƒ…æ™¯, æˆ‘ä»¬åªéœ€è¦æ˜¾ç¤ºä½¿ç”¨è€…æœ€åŽä¸€æ¬¡æ‰“åœ¨é¡µé¢ä¸Šçš„æ–‡å­—æ¥è¿›è¡Œå»ºè®®é€‰é¡¹,è€Œä¸ç”¨æ¯ä¸€æ¬¡éƒ½å‘é€ä¸€æ¬¡è¯·æ±‚

switchMap çš„ç¬¬äºŒä¸ªå‚æ•°çš„è¡Œä¸ºå’Œ concatMap ä¸€æ ·,è¿™é‡Œä¸å†èµ˜è¿°

### mergeMap

mergeMap ä¹Ÿèƒ½ä¼ å…¥ç¬¬äºŒä¸ªå‚æ•°, è·Ÿä¸Šé¢è®²çš„ switchMap å’Œ concatMap çš„ç¬¬äºŒä¸ªå‚æ•°çš„è¡Œä¸ºä¹Ÿæ˜¯å®Œå…¨ä¸€æ ·çš„, ä½†æ˜¯ mergeMap çš„é‡ç‚¹æ˜¯å¯ä»¥ä¼ å…¥ç¬¬ä¸‰ä¸ªå‚æ•°æ¥é™åˆ¶å¹¶è¡Œå¤„ç†çš„æ•°é‡

### switchMap, mergeMap, concatMap

è¿™ä¸‰ä¸ª operators è¿˜æœ‰ä¸€ä¸ªå…±åŒç‚¹çš„ç‰¹æ€§å°±æ˜¯å¯ä»¥å§ç¬¬ä¸€ä¸ªå‚æ•°æ‰€è¿”å›žçš„ promiseå¯¹è±¡ç›´æŽ¥è½¬æˆ observable, è¿™æ ·æˆ‘ä»¬å°±ä¸éœ€è¦åœ¨ç”¨`Rx.Observable.from`æ¥è½¬æ¢ä¸€æ¬¡

```javascript
function getPostData() {
    return fetch('https://jsonplaceholder.typicode.com/posts/1')
 	 .then(res => res.json())
}
const source = Rx.Observable.fromEvent(document.body, 'click')
const example = source.concatMap(e => getPostData()) // ç›´æŽ¥ä¼ å›ž promise
```

## æŠŠä¸€èˆ¬æµè½¬æ¢æˆé«˜é˜¶æµ

### window

window æ€»å…±æœ‰äº”ä¸ªç›¸å…³çš„ operator

- window
- windowCount
- windowTime
- windowToggle
- windowWhen

window ä¸Ž buffer ç±»ä¼¼ , å¯ä»¥æŠŠä¸€æ®µæ—¶é—´å†…é€å‡ºçš„å…ƒç´ æ‹†åˆ†å‡ºæ¥

 buffer æ˜¯æ ¹æ®ä¼ å…¥çš„ source2åŽ»æŠŠ source çš„å…ƒç´ æ‹†åˆ†åˆå¹¶åˆ°æ•°ç»„ä¸­

```javascript
source.buffer(source2)
/* Marble Diagram
source : --0--1--2--3--4--5--6--7..
source2: ---------0---------1--------...
            buffer(source2)
example: ---------([0,1,2])---------([3,4,5])
*/
```

è‹¥`source.window(source2)`

è€Œ window åˆ™æ˜¯æ ¹æ® source æŠŠ source2 çš„å…ƒç´ æ‹†åˆ†åˆå¹¶åˆ°æ–°çš„ observable

çœ‹ä¸€ä¸ªæ —å­:

```javascript
const click = Rx.Observable.fromEvent(document, 'click')
const source = Rx.Observable.interval(1000)
const example = source.window(click)
example.map(innerObservable => innerObservable.count())
	.switch()
	.subscribe(console.log)
```

Marble Diagram

```javascript
source : ---------0---------1---------2--...
click  : --cc---cc----c-c----------------...
                    window(source)
example: o--------o---------o---------o--..
         \        \         \         \
          -cc---cc|---c-c---|---------|--..
                    count()
       : o--------o---------o---------o--
         \        \         \         \
          -------4|--------2|--------0|--..
                    switch()
       : ---------4---------2---------0--...
```

### windowToggle

windowToggle ä¸åƒ window åªèƒ½æŽ§åˆ¶å†…éƒ¨ observable çš„ç»“æŸ, windowToggle å¯ä»¥ä¼ å…¥ä¸¤ä¸ªå‚æ•°, ç¬¬ä¸€ä¸ªæ˜¯å¼€å§‹çš„ observable, ç¬¬äºŒä¸ªæ˜¯ä¸€ä¸ª callback å¯ä»¥å›žä¼ ä¸€ä¸ªç»“æŸçš„ observable, ðŸŒ°:

```javascript
const source = Rx.Observable.interval(1000);
const mouseDown = Rx.Observable.fromEvent(document, 'mousedown');
const mouseUp = Rx.Observable.fromEvent(document, 'mouseup');

const example = source
  .windowToggle(mouseDown, () => mouseUp)
  .switch();

example.subscribe(console.log);
```

Marble Diagram

```javascript
source   : ----0----1----2----3----4----5--...

mouseDown: -------D------------------------...
mouseUp  : ---------------------------U----...

        windowToggle(mouseDown, () => mouseUp)

         : -------o-------------------------...
                  \
                   -1----2----3----4--|
                   switch()
example  : ---------1----2----3----4---------...
```
